name: ML Model Training

on:
  workflow_dispatch:

jobs:
  train:
    # This uses the free 7 GB runner.
    runs-on: ubuntu-latest

    # -----------------------------------------------------------
    # THIS IS THE FIX FOR THE "403 Forbidden" ERROR
    permissions:
      contents: write  # Allows the job to push commits
    # -----------------------------------------------------------

    timeout-minutes: 360 # 6-hour timeout

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        # Use the Python 3.10 Dockerfile you have
        run: docker build -t mlflow-dvc-trainer .

      - name: Run DVC, Train, and Push in Container
        env:
          GDRIVE_CREDS_JSON: ${{ secrets.GDRIVE_CREDENTIALS }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          docker run \
            --rm \
            -e GDRIVE_CREDS_JSON \
            -e GITHUB_TOKEN \
            -v ${{ github.workspace }}:/app \
            -w /app \
            mlflow-dvc-trainer \
            bash -c '
              # Use single quotes to protect the JSON secret
              
              echo "--- 1. AUTHENTICATING DVC ---"
              echo "$GDRIVE_CREDS_JSON" > gdrive-creds.json
              dvc remote modify --local myremote gdrive_service_account_json_file_path gdrive-creds.json
              dvc remote modify --local myremote gdrive_use_service_account true

              echo "--- 2. PULLING DATA ---"
              dvc pull

              echo "--- 3. RUNNING BATCH TRAINING ---"
              python EEG_TRAIN_MODEL.py

              echo "--- 4. PUSHING MODEL TO REPO ---"
              # Set up Git authentication
              git config --global user.name "github-actions[bot]"
              git config --global user.email "github-actions[bot]@users.noreply.github.com"
              git config --global --add safe.directory /app
              git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
              
              # Add all 3 output files
              git add UTIL_DYNAMIC/dynamic_svc_model.pkl
              git add UTIL_DYNAMIC/dynamic_scaler.pkl
              git add UTIL_DYNAMIC/common_channels.txt

              git commit -m "CHORE: Automated batch training" || echo "No new model to commit"
              git push
            '